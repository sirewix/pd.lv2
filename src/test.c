#include <stdlib.h>
#include <time.h>
#include <unistd.h>
#include <string.h>
#include <stdbool.h>

#include "pd/z_libpd.h"
#include "pd/s_stuff.h"

#define DEBUG

#include "common.h"
#include "buffer.h"
#include "pd_stuff.h"

#define TICK_SIZE 64


float real_input[] = {0.010580, 0.009521, 0.008475, 0.007420, 0.006334, 0.005205, 0.004026, 0.002799, 0.001535, 0.000247, -0.001043, -0.002319, -0.003561, -0.004759, -0.005907, -0.007007, -0.008072, -0.009118, -0.010168, -0.011247, -0.012380, -0.013585, -0.014876, -0.016255, -0.017716, -0.019239, -0.020798, -0.022355, -0.023872, -0.025307, -0.026624, -0.027793, -0.028793, -0.029617, -0.030271, -0.030774, -0.031156, -0.031457, -0.031721, -0.031994, -0.032318, -0.032730, -0.033254, -0.033906, -0.034685, -0.035579, -0.036567, -0.037616, -0.038688, -0.039744, -0.040745, -0.041655, -0.042444, -0.043088, -0.043570, -0.043878, -0.044004, -0.043943, -0.043686, -0.043225, -0.042545, -0.041627, -0.040446, -0.038975, -0.037184, -0.035045, -0.032535, -0.029640, -0.026357, -0.022698, -0.018691, -0.014380, -0.009825, -0.005097, -0.000277, 0.004547, 0.009290, 0.013868, 0.018209, 0.022252, 0.025951, 0.029276, 0.032214, 0.034765, 0.036944, 0.038771, 0.040276, 0.041486, 0.042431, 0.043135, 0.043618, 0.043896, 0.043978, 0.043871, 0.043582, 0.043118, 0.042491, 0.041717, 0.040819, 0.039826, 0.038774, 0.037701, 0.036647, 0.035650, 0.034743, 0.033950, 0.033283, 0.032744, 0.032320, 0.031987, 0.031709, 0.031446, 0.031150, 0.030779, 0.030291, 0.029656, 0.028852, 0.027872, 0.026723, 0.025423, 0.024000, 0.022493, 0.020940, 0.019382, 0.017855, 0.016388, 0.015001, 0.013702, 0.012489, 0.011351, 0.010268, 0.009218, 0.008175, 0.007115, 0.006022, 0.004882, 0.003692, 0.002457, 0.001188, -0.000099, -0.001385, -0.002649, -0.003878, -0.005060, -0.006192, -0.007279, -0.008333, -0.009376, -0.010429, -0.011517, -0.012665, -0.013889, -0.015201, -0.016600, -0.018076, -0.019608, -0.021166, -0.022713, -0.024208, -0.025612, -0.026889, -0.028011, -0.028962, -0.029737, -0.030347, -0.030813, -0.031168, -0.031454, -0.031715, -0.031997, -0.032341, -0.032780, -0.033336, -0.034021, -0.034830, -0.035750, -0.036755, -0.037812, -0.038881, -0.039924, -0.040901, -0.041779, -0.042529, -0.043130, -0.043565, -0.043824, -0.043900, -0.043788, -0.043478, -0.042961, -0.042221, -0.041238, -0.039985, -0.038435, -0.036557, -0.034326, -0.031720, -0.028728, -0.025350, -0.021604, -0.017521, -0.013148, -0.008550, -0.003801, 0.001017, 0.005816, 0.010511, 0.015022, 0.019278, 0.023223, 0.026815, 0.030029, 0.032856, 0.035299, 0.037376, 0.039110, 0.040529, 0.041663, 0.042539, 0.043180, 0.043606, 0.043830, 0.043861, 0.043705, 0.043369, 0.042861, 0.042194, 0.041386, 0.040462, 0.039452, 0.038393, 0.037324, 0.036284, 0.035311, 0.034435, 0.033676, 0.033046, 0.032541, 0.032145, 0.031831, 0.031562, 0.031295, 0.030984, 0.030586, 0.030063, 0.029385, 0.028537, 0.027513, 0.026324, 0.024991, 0.023546, 0.022025, 0.020471, 0.018922, 0.017412, 0.015969, 0.014608, 0.013336, 0.012148, 0.011029, 0.009960, 0.008917, 0.007874, 0.006810, 0.005707, 0.004557, 0.003357, 0.002115, 0.000842, -0.000443, -0.001722, -0.002975, -0.004189, -0.005355, -0.006471, -0.007545, -0.008592, -0.009632, -0.010689, -0.011789, -0.012953, -0.014197, -0.015529, -0.016947, -0.018437, -0.019976, -0.021530, -0.023064, -0.024535, -0.025904, -0.027139, -0.028213, -0.029115, -0.029842, -0.030409, -0.030841, -0.031173, -0.031447, -0.031709, -0.032003, -0.032368, -0.032835, -0.033424, -0.034141, -0.034980, -0.035924, -0.036943, -0.038004, -0.039068, -0.040094, -0.041046, -0.041890, -0.042600, -0.043156, -0.043544, -0.043754, -0.043780, -0.043616, -0.043253, -0.042679, -0.041878, -0.040828, -0.039502, -0.037870, -0.035906, -0.033581, -0.030879, -0.027790, -0.024321, -0.020489, -0.016334, -0.011905, -0.007270, -0.002506, 0.002304, 0.007071, 0.011713, 0.016150, 0.020317, 0.024161, 0.027645, 0.030748, 0.033464, 0.035802, 0.037779, 0.039422, 0.040758, 0.041817, 0.042626, 0.043207, 0.043577, 0.043747, 0.043727, 0.043523, 0.043141, 0.042591, 0.041886, 0.041046, 0.040097, 0.039073, 0.038010, 0.036948, 0.035925, 0.034978, 0.034133, 0.033411, 0.032816, 0.032343, 0.031973, 0.031676, 0.031413, 0.031140, 0.030810, 0.030383, 0.029822, 0.029102, 0.028208, 0.027141, 0.025914, 0.024551, 0.023085, 0.021556, 0.020003, 0.018465, 0.016975, 0.015556, 0.014222, 0.012976, 0.011812, 0.010711, 0.009655, 0.008616, 0.007572, 0.006502, 0.005390, 0.004229, 0.003020, 0.001771, 0.000496, -0.000786, -0.002056, -0.003297, -0.004495, -0.005645, -0.006746, -0.007808, -0.008848, -0.009888, -0.010952, -0.012064, -0.013245, -0.014509, -0.015861, -0.017297, -0.018798, -0.020341, -0.021890, -0.023407, -0.024850, -0.026183, -0.027374, -0.028400, -0.029252, -0.029933, -0.030460, -0.030860, -0.031171, -0.031436, -0.031702, -0.032011, -0.032400, -0.032897, -0.033518, -0.034267, -0.035134, -0.036099, -0.037131, -0.038194, -0.039248, -0.040255, -0.041179, -0.041987, -0.042656, -0.043167, -0.043507, -0.043668, -0.043644, -0.043427, -0.043010, -0.042379, -0.041516, -0.040397, -0.038996, -0.037282, -0.035228, -0.032810, -0.030012, -0.026828, -0.023268, -0.019355, -0.015132, -0.010652, -0.005986, -0.001214, 0.003581, 0.008310, 0.012892, 0.017252, 0.021327, 0.025068, 0.028442, 0.031433, 0.034040, 0.036273, 0.038153, 0.039707, 0.040963, 0.041950, 0.042694, 0.043215, 0.043530, 0.043648, 0.043578, 0.043326, 0.042899, 0.042307, 0.041566, 0.040696, 0.039726, 0.038691, 0.037627, 0.036574, 0.035571, 0.034651, 0.033840, 0.033153, 0.032594, 0.032152, 0.031806, 0.031523, 0.031262, 0.030979, 0.030628, 0.030169, 0.029569, 0.028805, 0.027867, 0.026758, 0.025495, 0.024104, 0.022621, 0.021086, 0.019537, 0.018013, 0.016544, 0.015151, 0.013844, 0.012624, 0.011481, 0.010398, 0.009351, 0.008316, 0.007270, 0.006192, 0.005071, 0.003899, 0.002682, 0.001427, 0.000152, -0.001125, -0.002386, -0.003613, -0.004796, -0.005929, -0.007015, -0.008067, -0.009102, -0.010143, -0.011215, -0.012341, -0.013540, -0.014824, -0.016196, -0.017647, -0.019159, -0.020703, -0.022243, -0.023740, -0.025154, -0.026448, -0.027594, -0.028571, -0.029374, -0.030010, -0.030498, -0.030869, -0.031163, -0.031423, -0.031696, -0.032022, -0.032437, -0.032965, -0.033619, -0.034399, -0.035292, -0.036275, -0.037316, -0.038378, -0.039421, -0.040406, -0.041299, -0.042071, -0.042697, -0.043162, -0.043454, -0.043565, -0.043491, -0.043222, -0.042751, -0.042061, -0.041134, -0.039945, -0.038467, -0.036669, -0.034526, -0.032014, -0.029119, -0.025842, -0.022194, -0.018204, -0.013916, -0.009392, -0.004701, 0.000073, 0.004846, 0.009532, 0.014049, 0.018327, 0.022306, 0.025941, 0.029205, 0.032085, 0.034584, 0.036714, 0.038499, 0.039966, 0.041144, 0.042061, 0.042742, 0.043205, 0.043465, 0.043533, 0.043414, 0.043115, 0.042643, 0.042011, 0.041235, 0.040338, 0.039349, 0.038305, 0.037243, 0.036203, 0.035221, 0.034331, 0.033554, 0.032904, 0.032379, 0.031966, 0.031641, 0.031369, 0.031107, 0.030811, 0.030436, 0.029944, 0.029303, 0.028495, 0.027512, 0.026363, 0.025066, 0.023651, 0.022154, 0.020615, 0.019074, 0.017566, 0.016119, 0.014752, 0.013473, 0.012278, 0.011156, 0.010088, 0.009049, 0.008016, 0.006966, 0.005880, 0.004748, 0.003567, 0.002342, 0.001084, -0.000191, -0.001462, -0.002712, -0.003925, -0.005091, -0.006208, -0.007281, -0.008323, -0.009355, -0.010399, -0.011480, -0.012621, -0.013839, -0.015143, -0.016534, -0.018000, -0.019519, -0.021062, -0.022590, -0.024065, -0.025446, -0.026700, -0.027798, -0.028727, -0.029482, -0.030074, -0.030526, -0.030871, -0.031151, -0.031409, -0.031692, -0.032037, -0.032479, -0.033039, -0.033725, -0.034535, -0.035453, -0.036452, -0.037500, -0.038558, -0.039586, -0.040547, -0.041408, -0.042140, -0.042723, -0.043141, -0.043385, -0.043447, -0.043321, -0.043000, -0.042473, -0.041724, -0.040732, -0.039472, -0.037915, -0.036033, -0.033798, -0.031191, -0.028202, -0.024832, -0.021099, -0.017035, -0.012689, -0.008125, -0.003417, 0.001353, 0.006098, 0.010733, 0.015181, 0.019373, 0.023252, 0.026781, 0.029934, 0.032704, 0.035095, 0.037125, 0.038817, 0.040200, 0.041303, 0.042152, 0.042771, 0.043177, 0.043384, 0.043401, 0.043234, 0.042888, 0.042374, 0.041703, 0.040894, 0.039972, 0.038968, 0.037917, 0.036860, 0.035835, 0.034878, 0.034018, 0.033277, 0.032662, 0.032171, 0.031786, 0.031479, 0.031215, 0.030949, 0.030637, 0.030235, 0.029707, 0.029024, 0.028172, 0.027146, 0.025958, 0.024630, 0.023193, 0.021685, 0.020146, 0.018615, 0.017125, 0.015702, 0.014361, 0.013109, 0.011938, 0.010836, 0.009781, 0.008749, 0.007716, 0.006661, 0.005567, 0.004425, 0.003234, 0.002002, 0.000741, -0.000531, -0.001795, -0.003033, -0.004231, -0.005380, -0.006481, -0.007542, -0.008576, -0.009606, -0.010655, -0.011747, -0.012904, -0.014141, -0.015465, -0.016874, -0.018353, -0.019877, -0.021416, -0.022930, -0.024379, -0.025725, -0.026936, -0.027987, -0.028867, -0.029574, -0.030125, -0.030543, -0.030866, -0.031135, -0.031395, -0.031689, -0.032057, -0.032528, -0.033119, -0.033838, -0.034676, -0.035616, -0.036629, -0.037680, -0.038731, -0.039742, -0.040677, -0.041503, -0.042196, -0.042734, -0.043105, -0.043300, -0.043313, -0.043136, -0.042762, -0.042179, -0.041369, -0.040311, -0.038977, -0.037340, -0.035371, -0.033045, -0.030344, -0.027260, -0.023800, -0.019985, -0.015851, -0.011452, -0.006854, -0.002134, 0.002624, 0.007335, 0.011915, 0.016288, 0.020389, 0.024167, 0.027587, 0.030630, 0.033289, 0.035576, 0.037507, 0.039109, 0.040410, 0.041439, 0.042222, 0.042781, 0.043132, 0.043287, 0.043254, 0.043039, 0.042648, 0.042092, 0.041384, 0.040544, 0.039599, 0.038582, 0.037529, 0.036479, 0.035472, 0.034541, 0.033714, 0.033008, 0.032428, 0.031969, 0.031609, 0.031319, 0.031059, 0.030786, 0.030455, 0.030023, 0.029458, 0.028733, 0.027836, 0.026768, 0.025543, 0.024186, 0.022730, 0.021214, 0.019678, 0.018159, 0.016689, 0.015291, 0.013978, 0.012751, 0.011604, 0.010520, 0.009476, 0.008450, 0.007415, 0.006354, 0.005250, 0.004098, 0.002899, 0.001661, 0.000399, -0.000869, -0.002124, -0.003349, -0.004531, -0.005664, -0.006751, -0.007799, -0.008827, -0.009857, -0.010912, -0.012016, -0.013190, -0.014447, -0.015791, -0.017216, -0.018706, -0.020233, -0.021765, -0.023261, -0.024682, -0.025992, -0.027158, -0.028161, -0.028992, -0.029653, -0.030164, -0.030552, -0.030855, -0.031116, -0.031380, -0.031690, -0.032082, -0.032582, -0.033206, -0.033956, -0.034821, -0.035781, -0.036805, -0.037857, -0.038898, -0.039890, -0.040796, -0.041586, -0.042237, -0.042730, -0.043054, -0.043200, -0.043162, -0.042934, -0.042507, -0.041866, -0.040995, -0.039869, -0.038461, -0.036742, -0.034685, -0.032267, -0.029471, -0.026294, -0.022746, -0.018852, -0.014654, -0.010207, -0.005582, -0.000856, 0.003884, 0.008555, 0.013073, 0.017367, 0.021375, 0.025050, 0.028360, 0.031291, 0.033842, 0.036025, 0.037860, 0.039374, 0.040596, 0.041554, 0.042273, 0.042774, 0.043070, 0.043174, 0.043091, 0.042829, 0.042394, 0.041798, 0.041054, 0.040186, 0.039221, 0.038193, 0.037140, 0.036101, 0.035113, 0.034211, 0.033417, 0.032747, 0.032202, 0.031773, 0.031436, 0.031159, 0.030901, 0.030617, 0.030264, 0.029801, 0.029196};

int test_process(const int n, const float* in, float* out) {
  debug("process called for %i ticks: ", n);
  debug_float_array(in, n * TICK_SIZE);
  memcpy(out, in, n * TICK_SIZE * sizeof(float));
}

void fixed_input(int* step_size, LeBuffer* buf, int in_size, float* input, float* output) {
  for (int i = 0; i < in_size; i+= *step_size) {
    if (i + *step_size >= in_size) {
      *step_size = in_size - i;
    }
    poomba(buf, &input[i], &output[i], *step_size, test_process);
  }
}

void random_input(void* _, LeBuffer* buf, int in_size, float* input, float* output) {
  int i = 0;
  srand(time(NULL));
  while (1) {
    int len = rand() % 9;
    if (i+len >= in_size) { len = in_size - i; }
    poomba(buf, &input[i], &output[i], len, test_process);
    if (i+len >= in_size) { break; }
    i += len;
  }
}

typedef void (*TestBufF)(void* p, LeBuffer* buf, int in_size, float* input, float* output);

int test_buf(
  char* name,
  void* p,
  TestBufF f
) {
  debug(">>>>>>>>>>> Testing %s <<<<<<<<<<<\n", name);
  LeBuffer buf = init_buffer(TICK_SIZE);
  const const int IN_SIZE = sizeof(real_input) / sizeof(float);
  //float input[IN_SIZE ];// = {1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0, 13.0, 14.0, 15.0, 16.0, 17.0, 18.0, 19.0, 20.0};
  /*
  for (int i = 0; i < IN_SIZE; i++) {
    input[i] = (float) (i + 1);
  }
  */
  // float* input = real_input;
  float output[IN_SIZE + TICK_SIZE];
  memset(&output, 0, IN_SIZE * sizeof(float));

  f(p, &buf, IN_SIZE, (float*) real_input, (float*) &output);

  bool result_is_incorrect =
  memcmp(real_input, &output[TICK_SIZE], IN_SIZE - TICK_SIZE * sizeof(float));
    // memcmp(output, &output[TICK_SIZE], TICK_SIZE * sizeof(float));

  if (result_is_incorrect) {
    debug("result is incorrect: ");
    debug_float_array(output, IN_SIZE);
    debug_buf(&buf);
  }
  free_buffer(&buf);

  return result_is_incorrect;
}

int test_random_input_buf() {
  for (int i = 0; i < 100; i++) {
    if (test_buf("Random input", NULL, (TestBufF) random_input)) return 1;
  }
}

int test_libpd_process() {
  debug(">>>>>>>>>>> Testing libpd_process <<<<<<<<<<<\n");
  libpd_init();
  void* patch_fd = libpd_openfile("filter-test.pd", "/home/wyx");
  if (libpd_init_audio(1, 1, 48000)) {
    printf("libpd audio init failed\n");
    return 1;
  }
  // LeBuffer buf = init_buffer(libpd_blocksize());
  //debug("initialized buffer, tick_size: %i\n", libpd_blocksize());
  int tick_size = libpd_blocksize();

  libpd_start_message(1);
  libpd_add_float(1.0f);
  libpd_finish_message("pd", "dsp");

  int ticks = 1;

  float* proc_buf = (float*) malloc(2 * ticks * tick_size * sizeof(float));
  float* process_buf_in = (float*) proc_buf;
  for (int i = 0; i < ticks * tick_size; i++) {
    process_buf_in[i] = i%2 ? 1.5 : -1.5;
  }
  float* process_buf_out = (float*) &proc_buf[ticks * tick_size];

  debug("processing\n");
  return libpd_process_float(ticks, process_buf_in, process_buf_out);

  //debug_float_array(process_buf_out, ticks * tick_size);
}

int test_gen_patch_id() {
  char* patch_id = gen_patch_id();
  debug("%s %i\n", patch_id, strlen(patch_id ));
  return !(strlen(gen_patch_id()) == 16);
}

#define ANSI_RED "\e[1;31m"
#define ANSI_GREEN "\e[1;32m"
#define ANSI_RESET "\e[0m"

int main() {
  int data[] = {0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10};
  int i512 = 512;
  int i1024 = 1024;
  int res =
     test_buf("Fixed input 1", (void*)(&data[1]), (TestBufF) fixed_input)
  || test_buf("Fixed input 2", (void*)(&data[2]), (TestBufF) fixed_input)
  || test_buf("Fixed input 3", (void*)(&data[3]), (TestBufF) fixed_input)
  || test_buf("Fixed input 4", (void*)(&data[4]), (TestBufF) fixed_input)
  || test_buf("Fixed input 5", (void*)(&data[5]), (TestBufF) fixed_input)
  || test_buf("Fixed input 7", (void*)(&data[7]), (TestBufF) fixed_input)
  || test_buf("Fixed input 8", (void*)(&data[8]), (TestBufF) fixed_input)
  || test_buf("Fixed input 9", (void*)(&data[9]), (TestBufF) fixed_input)
  || test_random_input_buf()
  || test_libpd_process()
  || test_buf("Fixed input 512", (void*)(&i512), (TestBufF) fixed_input)
  || test_buf("Fixed input 1024", (void*)(&i1024), (TestBufF) fixed_input)
  || test_gen_patch_id()
  ;
  if (res) debug("\n" ANSI_RED "Tests fail!" ANSI_RESET "\n");
  else debug("\n" ANSI_GREEN "Tests pass" ANSI_RESET "\n");
  return res;
}

